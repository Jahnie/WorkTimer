<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥å·¥æ—¶è®°å½•å™¨ï¼ˆFirebase å®‰å…¨åŒæ­¥ï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'å¾®è½¯é›…é»‘', 'Microsoft YaHei', Arial, sans-serif; }
        body { background: #f5f7fa; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { color: #2d3748; font-size: 24px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); padding: 25px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #666; font-size: 14px; font-weight: 500; }
        input, select, button { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; }
        input:focus, select:focus { outline: none; border-color: #4299e1; }
        .btn-primary { 
            background: #4299e1; 
            color: white; 
            border: none; 
            cursor: pointer; 
            transition: background 0.3s; 
            font-weight: 500; 
            margin-top: 5px;
        }
        .btn-primary:hover { background: #3182ce; }
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(4, minmax(100px, 1fr));
            gap: 15px; 
            margin-bottom: 25px; 
        } 
        .stat-item { text-align: center; padding: 15px 5px; background: #f8fafc; border-radius: 6px; }
        .stat-item h3 { 
            color: #666; 
            font-size: 14px; 
            margin-bottom: 5px; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            padding: 0 5px;
        }
        .stat-item .value { color: #4299e1; font-size: 22px; font-weight: bold; }
        .stat-item .overtime-value { color: #e53e3e; }
        .history { max-height: 250px; overflow-y: auto; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { padding: 10px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .history-table th { color: #666; }
        .history-table td { color: #333; }
        .overtime-td { color: #e53e3e; font-weight: 500; }
        .empty { text-align: center; padding: 30px; color: #999; font-size: 14px; }
        .option-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .option-row .form-group { flex: 1; min-width: 110px; margin-bottom: 0; }
        .tip { color: #999; font-size: 12px; margin-top: 5px; }
        .stat-filter-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-filter-row .form-group { flex: 1; margin-bottom: 0; }
        .delete-btn { 
            background: #e53e3e; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        .delete-btn:hover { background: #c53030; }
        .month-details-card { display: none; } 
        .month-details-card h3 { display: flex; justify-content: space-between; align-items: center; font-size: 16px; color: #2d3748; }
        .month-details-card .close-btn { 
            font-size: 18px; 
            cursor: pointer; 
            color: #ccc; 
            background: none; 
            border: none; 
            padding: 0;
            transition: color 0.3s;
        }
        .month-details-card .close-btn:hover { color: #333; }
        .details-table-container { max-height: 400px; overflow-y: auto; margin-top: 15px; }

        /* é€€å‡ºæŒ‰é’®æ ·å¼ */
        #sign-out-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ¯æ—¥å·¥æ—¶ä¸€é”®è®°å½•ï¼ˆFirebase å®‰å…¨åŒæ­¥ï¼‰</h1>
        </div>

        <div id="auth-container" class="card">
            <h3>ğŸ” ç”¨æˆ·è®¤è¯ï¼ˆé‚®ç®±/å¯†ç ç™»å½•ï¼‰</h3>

            <div class="form-group">
                <label for="email-input">é‚®ç®±</label>
                <input type="email" id="email-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€">
            </div>

            <div class="form-group">
                <label for="password-input">å¯†ç </label>
                <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            
            <div id="auth-buttons-group">
                <button class="btn-primary" id="sign-up-button">æ³¨å†Œæ–°ç”¨æˆ·</button>
                <button class="btn-primary" id="sign-in-button" style="margin-top: 10px;">ç™»å½•</button>
            </div>
        </div>
        <div id="main-app-content" style="display:none;">
            <button class="btn-danger" id="sign-out-button">å®‰å…¨é€€å‡º</button>

            <div class="stat-filter-row">
                <div class="form-group">
                    <label for="filter-year">ç­›é€‰å¹´ä»½</label>
                    <select id="filter-year"></select>
                </div>
                <div class="form-group">
                    <label for="filter-month">ç­›é€‰æœˆä»½</label>
                    <select id="filter-month"></select>
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <h3 id="total-days-label">...æ€»å·¥ä½œå¤©æ•°</h3>
                    <div class="value" id="month-days">0 å¤©</div>
                </div>
                <div class="stat-item">
                    <h3 id="total-label">...æ€»å·¥æ—¶ (æ­£å¸¸)</h3>
                    <div class="value" id="month-total">0.0 å°æ—¶</div>
                </div>
                <div class="stat-item">
                    <h3 id="overtime-exchange-label">...åŠ ç­å…‘æ¢å¤©æ•°</h3> 
                    <div class="value overtime-value" id="month-overtime-exchange">0.0 å¤©</div>
                </div>
                <div class="stat-item">
                    <h3>æ‰€æœ‰è®°å½•å¤©æ•°</h3>
                    <div class="value" id="total-days">0 å¤©</div>
                </div>
            </div>

            <div class="card">
                <div class="option-row">
                    <div class="form-group">
                        <label for="work-date">å·¥ä½œæ—¥æœŸ</label>
                        <input type="date" id="work-date" required>
                        <div class="tip">é»˜è®¤ä»Šæ—¥ï¼Œå¯æ‰‹åŠ¨é€‰æ‹©</div>
                    </div>
                    <div class="form-group">
                        <label for="start-time">ä¸Šç­æ—¶é—´</label>
                        <select id="start-time"></select>
                        <div class="tip">é¦–æ¬¡é€‰æ‹©åè‡ªåŠ¨é»˜è®¤</div>
                    </div>
                    <div class="form-group">
                        <label for="end-time">ä¸‹ç­æ—¶é—´</label>
                        <select id="end-time"></select>
                        <div class="tip">é¦–æ¬¡é€‰æ‹©åè‡ªåŠ¨é»˜è®¤</div>
                    </div>
                    <div class="form-group">
                        <label for="rest-time">ä¼‘æ¯æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
                        <select id="rest-time">
                            <option value="0.0">0.0</option>
                            <option value="0.5">0.5</option>
                            <option value="1.0" selected>1.0</option>
                            <option value="1.5">1.5</option>
                            <option value="2.0">2.0</option>
                        </select>
                        <div class="tip">é¦–æ¬¡é€‰æ‹©åè‡ªåŠ¨é»˜è®¤</div>
                    </div>
                    <div class="form-group">
                        <label for="overtime-time">åŠ ç­æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
                        <select id="overtime-time">
                            <option value="0.0" selected>0.0</option>
                            <option value="0.5">0.5</option>
                            <option value="1.0">1.0</option>
                            <option value="1.5">1.5</option>
                            <option value="2.0">2.0</option>
                            <option value="2.5">2.5</option>
                            <option value="3.0">3.0</option>
                        </select>
                        <div class="tip">é¦–æ¬¡é€‰æ‹©åè‡ªåŠ¨é»˜è®¤</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="work-type">å·¥ä½œç±»å‹</label>
                    <select id="work-type">
                        <option value="æ­£å¸¸å·¥ä½œ" selected>æ­£å¸¸å·¥ä½œ</option>
                        <option value="åŠ ç­">åŠ ç­</option>
                        <option value="è°ƒä¼‘">è°ƒä¼‘</option>
                        <option value="å‡ºå·®">å‡ºå·®</option>
                    </select>
                    <div class="tip">é¦–æ¬¡é€‰æ‹©åè‡ªåŠ¨é»˜è®¤</div>
                </div>
                <button class="btn-primary" id="one-click-record">ä¸€é”®è®°å½•å·¥æ—¶</button>
            </div>

            <div class="card month-details-card" id="month-details-card">
                <h3 id="month-details-title">
                    <span>æœˆä»½è¯¦ç»†è®°å½•</span>
                    <button class="close-btn" onclick="document.getElementById('month-details-card').style.display='none';">&times;</button>
                </h3>
                <div class="details-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>ä¸Šä¸‹ç­æ—¶é—´</th>
                                <th>ä¼‘æ¯/åŠ ç­ï¼ˆå°æ—¶ï¼‰</th>
                                <th>æ ¸å¿ƒå·¥æ—¶</th>
                                <th>å®é™…å·¥æ—¶</th>
                                <th>ç±»å‹</th>
                                <th>æ“ä½œ</th> 
                            </tr>
                        </thead>
                        <tbody id="month-details-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 15px; color: #2d3748; font-size: 16px;">è¿‘æœŸè®°å½•ï¼ˆæœ€è¿‘10æ¡ï¼‰</h3>
                <div class="history" id="history-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>ä¸Šä¸‹ç­æ—¶é—´</th>
                                <th>ä¼‘æ¯/åŠ ç­ï¼ˆå°æ—¶ï¼‰</th>
                                <th>å®é™…å·¥æ—¶ï¼ˆå°æ—¶ï¼‰</th>
                                <th>ç±»å‹</th>
                                <th>æ“ä½œ</th> 
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr><td colspan="6" class="empty">åŠ è½½ä¸­... è¯·ç­‰å¾…æ•°æ®åŒæ­¥</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // =======================================================
        // ğŸš¨ 1. Firebase é…ç½® (å·²ä½¿ç”¨æ‚¨æä¾›çš„æ­£ç¡®é…ç½®)
        // =======================================================
        const firebaseConfig = {
            // è¯·ç¡®ä¿è¿™ä¸ª API Key æ˜¯æ­£ç¡®çš„ Web API Key
            apiKey: "AIzaSyDHj7QaaOytBOOnvbwkGMxMhmt8HU5dSdU",
            authDomain: "worktimer-4bc4f.firebaseapp.com",
            projectId: "worktimer-4bc4f", 
            storageBucket: "worktimer-4bc4f.firebasestorage.app",
            messagingSenderId: "698553967835",
            appId: "1:698553967835:web:3008b0b379effca58898fe"
        };

        // =======================================================
        // 2. åˆå§‹åŒ– Firebase & å¼•ç”¨æœåŠ¡
        // =======================================================
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å¸¸é‡
        const STANDARD_DAY_HOURS = 9.5; 
        const USER_DEFAULTS_KEY = 'workDataDefaults'; 

        // å…ƒç´ å¼•ç”¨
        const workDateEl = document.getElementById('work-date');
        const startTimeEl = document.getElementById('start-time');
        const endTimeEl = document.getElementById('end-time');
        const restTimeEl = document.getElementById('rest-time');
        const overtimeTimeEl = document.getElementById('overtime-time');
        const workTypeEl = document.getElementById('work-type');
        const oneClickBtn = document.getElementById('one-click-record');
        const historyBodyEl = document.getElementById('history-body');

        const filterYearEl = document.getElementById('filter-year');
        const filterMonthEl = document.getElementById('filter-month');
        const totalDaysEl = document.getElementById('total-days');
        
        const monthDaysEl = document.getElementById('month-days');
        const monthTotalEl = document.getElementById('month-total');
        const monthOvertimeExchangeEl = document.getElementById('month-overtime-exchange');
        
        const monthDetailsCardEl = document.getElementById('month-details-card'); 
        const monthDetailsBodyEl = document.getElementById('month-details-body');
        
        // **ä¿®æ”¹ï¼šEmail/Password è®¤è¯å…ƒç´ **
        const authContainerEl = document.getElementById('auth-container');
        const mainAppContentEl = document.getElementById('main-app-content');
        const emailInputEl = document.getElementById('email-input');
        const passwordInputEl = document.getElementById('password-input');
        const signUpButton = document.getElementById('sign-up-button');
        const signInButton = document.getElementById('sign-in-button');
        // **ä¿®æ”¹ç»“æŸ**

        let allRecords = []; // å­˜å‚¨å½“å‰ç”¨æˆ·çš„å…¨éƒ¨è®°å½•

        // =======================================================
        // 3. åˆå§‹è®¾ç½®å’ŒåŠ è½½ (ä¿æŒä¸å˜)
        // =======================================================
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            workDateEl.value = today;
            generateTimeOptions(startTimeEl);
            generateTimeOptions(endTimeEl);
            restoreDefaultOptions();
            generateFilterOptions(allRecords); 
        };

        function generateTimeOptions(selectEl) {
            let optionsHtml = '';
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const h = hour.toString().padStart(2, '0');
                    const m = minute.toString().padStart(2, '0');
                    optionsHtml += `<option value="${h}:${m}">${h}:${m}</option>`;
                }
            }
            selectEl.innerHTML = optionsHtml;
        }

        function restoreDefaultOptions() {
            const defaults = JSON.parse(localStorage.getItem(USER_DEFAULTS_KEY)) || {};
            startTimeEl.value = defaults.startTime || '09:00';
            endTimeEl.value = defaults.endTime || '18:30';
            restTimeEl.value = defaults.restTime || '1.0';
            overtimeTimeEl.value = defaults.overtimeTime || '0.0';
            workTypeEl.value = defaults.workType || 'æ­£å¸¸å·¥ä½œ';
        }

        function saveDefaultOptions() {
            const defaults = {
                startTime: startTimeEl.value,
                endTime: endTimeEl.value,
                restTime: restTimeEl.value,
                overtimeTime: overtimeTimeEl.value,
                workType: workTypeEl.value
            };
            localStorage.setItem(USER_DEFAULTS_KEY, JSON.stringify(defaults));
        }

        // =======================================================
        // 4. èº«ä»½éªŒè¯é€»è¾‘ (Email/Password ç™»å½•)
        // =======================================================

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ– (ç”¨æˆ·åˆ·æ–°æˆ–é¦–æ¬¡åŠ è½½æ—¶è§¦å‘)
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // ç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºåº”ç”¨ä¸»ä½“
                authContainerEl.style.display = 'none';
                mainAppContentEl.style.display = 'block';
                await loadAllWorkRecords(); // å¼‚æ­¥åŠ è½½æ•°æ®
            } else {
                // ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
                authContainerEl.style.display = 'block';
                mainAppContentEl.style.display = 'none';
            }
        });

        // é€€å‡ºç™»å½•
        document.getElementById('sign-out-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                alert('å·²å®‰å…¨é€€å‡ºã€‚');
            }).catch((error) => {
                console.error("é€€å‡ºå¤±è´¥:", error);
                alert('é€€å‡ºå¤±è´¥ã€‚');
            });
        });

        // æ³¨å†Œæ–°ç”¨æˆ·
        signUpButton.addEventListener('click', () => {
            const email = emailInputEl.value.trim();
            const password = passwordInputEl.value.trim();
            if (!email || !password || password.length < 6) { 
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±å’Œè‡³å°‘6ä½å¯†ç ï¼'); 
                return; 
            }
            
            signUpButton.disabled = true;
            signUpButton.textContent = 'æ³¨å†Œä¸­...';

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    alert(`æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿æ–°ç”¨æˆ·: ${userCredential.user.email}`);
                    // onAuthStateChanged ä¼šå¤„ç†åç»­çš„ UI åˆ‡æ¢å’Œæ•°æ®åŠ è½½
                })
                .catch((error) => {
                    console.error("æ³¨å†Œå¤±è´¥:", error);
                    alert('æ³¨å†Œå¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    signUpButton.disabled = false;
                    signUpButton.textContent = 'æ³¨å†Œæ–°ç”¨æˆ·';
                });
        });

        // ç™»å½•ç°æœ‰ç”¨æˆ·
        signInButton.addEventListener('click', () => {
            const email = emailInputEl.value.trim();
            const password = passwordInputEl.value.trim();
            if (!email || !password) { 
                alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼'); 
                return; 
            }
            
            signInButton.disabled = true;
            signInButton.textContent = 'ç™»å½•ä¸­...';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    alert(`ç™»å½•æˆåŠŸï¼æ¬¢è¿å›æ¥: ${userCredential.user.email}`);
                    // onAuthStateChanged ä¼šå¤„ç†åç»­çš„ UI åˆ‡æ¢å’Œæ•°æ®åŠ è½½
                })
                .catch((error) => {
                    console.error("ç™»å½•å¤±è´¥:", error);
                    alert('ç™»å½•å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    signInButton.disabled = false;
                    signInButton.textContent = 'ç™»å½•';
                });
        });
        // **ä¿®æ”¹ç»“æŸ**

        // =======================================================
        // 5. Firestore æ•°æ®æ“ä½œ (ä¿æŒä¸å˜)
        // =======================================================
        
        function getRecordsRef() {
            const user = auth.currentUser;
            if (!user) { throw new Error("ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è®¿é—®æ•°æ®ã€‚"); }
            // æ•°æ®è·¯å¾„: users/{UID}/records
            return db.collection("users").doc(user.uid).collection("records");
        }

        /**
         * ä» Firestore åŠ è½½å½“å‰ç”¨æˆ·çš„æ‰€æœ‰å·¥æ—¶è®°å½•ã€‚
         */
        async function loadAllWorkRecords() {
            try {
                // æŒ‰ç…§æ—¥æœŸé™åºæ’åº (æœ€æ–°åœ¨å‰é¢)
                const snapshot = await getRecordsRef().orderBy('date', 'desc').get(); 
                allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ç¡®ä¿æ—¥æœŸæ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œä»¥ä¾¿åç»­æ’åºå’Œç­›é€‰
                allRecords.forEach(r => r.date = r.date || new Date().toISOString().split('T')[0]);

                generateFilterOptions(allRecords);
                updateStats();
                updateHistory();
            } catch (error) {
                console.error("åŠ è½½è®°å½•å¤±è´¥:", error);
                alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Firebaseé…ç½®ã€‚");
                historyBodyEl.innerHTML = '<tr><td colspan="6" class="empty">æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        /**
         * è®°å½•æˆ–æ›´æ–°ä¸€æ¡å·¥æ—¶è®°å½•ã€‚
         */
        async function recordWorkEntry(newRecord) {
            try {
                // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥æ—¥æœŸçš„è®°å½•
                const existing = allRecords.find(r => r.date === newRecord.date);
                
                let docRef;
                // å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°å®ƒï¼›å¦åˆ™ï¼Œæ–°å¢ä¸€ä¸ªæ–‡æ¡£
                if (existing) {
                    docRef = getRecordsRef().doc(existing.id);
                    await docRef.set(newRecord, { merge: true });
                    alert(`è®°å½• ${newRecord.date} å·²æˆåŠŸè¦†ç›–æ›´æ–°ï¼`);
                } else {
                    docRef = await getRecordsRef().add(newRecord);
                    alert(`è®°å½• ${newRecord.date} å·²æˆåŠŸæ–°å¢ï¼`);
                }

                // æ›´æ–°å®Œæˆåï¼Œé‡æ–°åŠ è½½å’Œåˆ·æ–°ç•Œé¢
                await loadAllWorkRecords(); 
                saveDefaultOptions(); // ä¿å­˜é»˜è®¤å€¼åˆ° localStorage
                
            } catch (error) {
                console.error("è®°å½•å·¥æ—¶å¤±è´¥:", error);
                alert("è®°å½•å·¥æ—¶å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
            }
        }

        /**
         * åˆ é™¤ä¸€æ¡å·¥æ—¶è®°å½•ã€‚
         */
        window.deleteRecord = async function(docId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ­¤æ¡è®°å½•å—ï¼Ÿ`)) {
                return;
            }
            try {
                await getRecordsRef().doc(docId).delete();
                await loadAllWorkRecords();
                alert("è®°å½•åˆ é™¤æˆåŠŸï¼");
            } catch (error) {
                console.error("åˆ é™¤è®°å½•å¤±è´¥:", error);
                alert("åˆ é™¤è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
            }
        }

        // =======================================================
        // 6. æ ¸å¿ƒé€»è¾‘ (è®¡ç®—å’Œè®°å½•) (ä¿æŒä¸å˜)
        // =======================================================
        
        oneClickBtn.addEventListener('click', async function() {
            const workDate = workDateEl.value;
            const startTime = startTimeEl.value;
            const endTime = endTimeEl.value;
            const restTime = parseFloat(restTimeEl.value) || 0;
            let overtimeTime = parseFloat(overtimeTimeEl.value) || 0; 
            const workType = workTypeEl.value;

            if (!workDate) { alert('è¯·é€‰æ‹©å·¥ä½œæ—¥æœŸï¼'); return; }
            if (!auth.currentUser) { alert('è¯·å…ˆç™»å½•ï¼'); return; }

            const totalHours = calculateHourDiff(startTime, endTime);
            // æ ¸å¿ƒå·¥æ—¶ = (æ‰“å¡æ€»æ—¶é•¿ - ä¼‘æ¯æ—¶é—´)ï¼Œå‘ä¸‹å–æ•´åˆ° 0
            const coreWorkHours = Math.max(0, totalHours - restTime); 

            // è‡ªåŠ¨è®¡ç®—åŠ ç­
            if (workType === 'æ­£å¸¸å·¥ä½œ' || workType === 'å‡ºå·®') {
                // è‡ªåŠ¨è®¡ç®—è¶…è¿‡æ ‡å‡†å·¥æ—¶éƒ¨åˆ†
                const calculatedOvertime = Math.max(0, coreWorkHours - STANDARD_DAY_HOURS);
                // å®é™…åŠ ç­æ—¶é—´ = (æ‰‹åŠ¨è¾“å…¥çš„åŠ ç­æ—¶é—´ + è‡ªåŠ¨è®¡ç®—çš„åŠ ç­æ—¶é—´)
                overtimeTime = parseFloat(overtimeTime) + calculatedOvertime; 
            }

            const actualOvertime = overtimeTime.toFixed(1);
            // å®é™…å·¥ä½œå°æ—¶ = æ ¸å¿ƒå·¥æ—¶ + å®é™…åŠ ç­æ—¶é—´
            const actualWorkHours = (coreWorkHours + parseFloat(actualOvertime)).toFixed(1); 

            const newRecord = {
                date: workDate, startTime, endTime,
                restTime: restTime.toFixed(1), overtimeTime: actualOvertime, 
                coreWorkHours: coreWorkHours.toFixed(1), // æ€»æ‰“å¡æ—¶é•¿ (å·²æ‰£é™¤ä¼‘æ¯)
                actualWorkHours, workType,
                // æ·»åŠ æ—¶é—´æˆ³ä¾¿äºæ’åº (è™½ç„¶æˆ‘ä»¬ä¸»è¦ç”¨ date å­—æ®µæ’åº)
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await recordWorkEntry(newRecord);
        });

        function calculateHourDiff(start, end) {
            if (!start || !end) return 0;
            const [sH, sM] = start.split(':').map(Number);
            const [eH, eM] = end.split(':').map(Number);
            let diffMin = (eH * 60 + eM) - (sH * 60 + sM);
            // è·¨å¤©è®¡ç®— (ä¾‹å¦‚ 23:00 åˆ° 01:00)
            if (diffMin < 0) {
                diffMin += 24 * 60; 
            }
            return diffMin/60; 
        }

        // =======================================================
        // 7. ç»Ÿè®¡å’Œå†å²æ˜¾ç¤º (ä¿æŒä¸å˜)
        // =======================================================
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸï¼Œåªæ˜¾ç¤ºæœˆæ—¥
        function formatDate(isoDate, showYear = false) {
            const parts = isoDate.split('-');
            if (parts.length < 3) return isoDate;
            const [year, month, day] = parts;
            return showYear ? `${year}-${month}-${day}` : `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
        }

        function generateFilterOptions(records) {
            const years = new Set();
            records.forEach(r => years.add(r.date.substring(0, 4)));
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            const currentSelectedYear = filterYearEl.value;
            const currentSelectedMonth = filterMonthEl.value;

            filterYearEl.innerHTML = '<option value="all">æ‰€æœ‰å¹´ä»½</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + ' å¹´';
                filterYearEl.appendChild(option);
            });

            filterMonthEl.innerHTML = '<option value="all">æ‰€æœ‰æœˆä»½</option>';
            for(let i = 1; i <= 12; i++) {
                const month = i.toString().padStart(2, '0');
                const option = document.createElement('option');
                option.value = month;
                option.textContent = i + ' æœˆ';
                filterMonthEl.appendChild(option);
            }
            
            // æ¢å¤/è®¾ç½®é»˜è®¤é€‰ä¸­é¡¹ (é»˜è®¤é€‰ä¸­å½“å‰å¹´æœˆ)
            const today = new Date();
            const currentYear = today.getFullYear().toString();
            const currentMonth = (today.getMonth() + 1).toString().padStart(2, '0');

            if (currentSelectedYear && (currentSelectedYear === 'all' || sortedYears.includes(currentSelectedYear))) {
                filterYearEl.value = currentSelectedYear;
            } else if (sortedYears.includes(currentYear)) {
                filterYearEl.value = currentYear;
            } else if (sortedYears.length > 0) {
                 filterYearEl.value = sortedYears[0]; 
            } else {
                 filterYearEl.value = 'all';
            }
            
            if (currentSelectedMonth && currentSelectedMonth !== 'all') {
                filterMonthEl.value = currentSelectedMonth;
            } else {
                filterMonthEl.value = currentMonth;
            }
        }
        
        filterYearEl.addEventListener('change', updateStats);
        filterMonthEl.addEventListener('change', updateStats);


        function updateStats() {
            const selectedYear = filterYearEl.value;
            const selectedMonth = filterMonthEl.value;
            
            const currentFilteredRecords = allRecords.filter(r => {
                const datePart = r.date.split('-');
                const recordYear = datePart[0];
                const recordMonth = datePart[1];
                
                const yearMatch = selectedYear === 'all' || recordYear === selectedYear;
                const monthMatch = selectedMonth === 'all' || recordMonth === selectedMonth;
                
                return yearMatch && monthMatch;
            });

            // æ›´æ–°æ ‡ç­¾æ–‡æœ¬ (æ—¶é—´èŒƒå›´)
            let timeScope = 'æ‰€æœ‰è®°å½•';
            if (selectedYear !== 'all' && selectedMonth !== 'all') {
                timeScope = `${selectedYear}å¹´${parseInt(selectedMonth)}æœˆ`;
            } else if (selectedYear !== 'all') {
                timeScope = `${selectedYear}å¹´`;
            } else if (selectedMonth !== 'all') {
                timeScope = `${parseInt(selectedMonth)}æœˆ`;
            }
            
            document.getElementById('total-days-label').textContent = `${timeScope}å·¥ä½œå¤©æ•°`;
            document.getElementById('total-label').textContent = `${timeScope}æ€»å·¥æ—¶ (æ­£å¸¸)`;
            document.getElementById('overtime-exchange-label').textContent = `${timeScope}åŠ ç­å…‘æ¢å¤©æ•°`; 

            // 1. è®¡ç®—ç­›é€‰å‡ºçš„æ€»å·¥æ—¶ (æ­£å¸¸éƒ¨åˆ†ï¼Œå³ä¸è¶…è¿‡æ ‡å‡†å·¥æ—¶ 9.5 å°æ—¶çš„éƒ¨åˆ†)
            const normalTotal = currentFilteredRecords.reduce((sum, r) => {
                return sum + Math.min(parseFloat(r.coreWorkHours) || 0, STANDARD_DAY_HOURS); 
            }, 0).toFixed(1);

            // 2. è®¡ç®—ç­›é€‰å‡ºçš„åŠ ç­æ€»æ—¶é•¿
            const overtimeTotal = currentFilteredRecords.reduce((sum, r) => sum + (parseFloat(r.overtimeTime) || 0), 0).toFixed(1);
            
            // 3. è®¡ç®—å·¥ä½œå¤©æ•° (å»é‡æ—¥æœŸ)
            const workDays = new Set(currentFilteredRecords.map(r => r.date)).size;

            // 4. è®¡ç®—åŠ ç­å…‘æ¢å¤©æ•°
            const exchangeDays = (parseFloat(overtimeTotal) / STANDARD_DAY_HOURS).toFixed(2);

            // æ›´æ–°æ˜¾ç¤º
            monthDaysEl.textContent = workDays + ' å¤©';
            monthTotalEl.textContent = normalTotal + ' å°æ—¶';
            monthOvertimeExchangeEl.textContent = exchangeDays + ' å¤©';
            totalDaysEl.textContent = allRecords.length + ' æ¡è®°å½•'; // æ€»è®°å½•æ¡æ•°
            
            showMonthDetails(currentFilteredRecords, timeScope);
        }

        function showMonthDetails(records, title) {
            const selectedMonth = filterMonthEl.value;
            const selectedYear = filterYearEl.value;

            // åªæœ‰å½“åŒæ—¶é€‰ä¸­å¹´å’Œæœˆæ—¶ï¼Œæ‰æ˜¾ç¤ºè¯¦ç»†è¡¨æ ¼
            if (selectedMonth === 'all' || selectedYear === 'all') {
                monthDetailsCardEl.style.display = 'none';
                return;
            }

            monthDetailsCardEl.style.display = 'block';
            document.getElementById('month-details-title').querySelector('span').textContent = `${title}è¯¦ç»†è®°å½•`;
            
            // æŒ‰ç…§æ—¥æœŸå‡åºæ’åº (ä»æ—§åˆ°æ–°)
            const sortedRecords = records.slice().sort((a, b) => new Date(a.date) - new Date(b.date));

            if (!sortedRecords.length) {
                monthDetailsBodyEl.innerHTML = '<tr><td colspan="7" class="empty">è¯¥æœˆæš‚æ— è®°å½•</td></tr>';
                return;
            }

            monthDetailsBodyEl.innerHTML = '';
            sortedRecords.forEach(record => {
                const coreHours = parseFloat(record.coreWorkHours) || 0;
                // æ­£å¸¸å·¥æ—¶ = æ ¸å¿ƒå·¥æ—¶ä¸­ä¸è¶…è¿‡æ ‡å‡†æ—¶é•¿çš„éƒ¨åˆ†
                const normalHours = Math.min(coreHours, STANDARD_DAY_HOURS).toFixed(1); 

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date, true)}</td>
                    <td>${record.startTime} - ${record.endTime}</td>
                    <td>${record.restTime} / <span class="overtime-td">${record.overtimeTime}</span></td>
                    <td>${normalHours}</td> 
                    <td>${record.actualWorkHours}</td>
                    <td>${record.workType}</td>
                    <td><button class="delete-btn" onclick="deleteRecord('${record.id}')">åˆ é™¤</button></td>
                `;
                monthDetailsBodyEl.appendChild(row);
            });
        }

        function updateHistory() {
            if (!allRecords.length) {
                historyBodyEl.innerHTML = '<tr><td colspan="6" class="empty">æš‚æ— è®°å½•ï¼Œç‚¹å‡»ä¸€é”®è®°å½•æ·»åŠ </td></tr>';
                return;
            }
            historyBodyEl.innerHTML = '';
            // æ˜¾ç¤ºæœ€æ–°çš„ 10 æ¡è®°å½•
            allRecords.slice(0,10).forEach(record => { 
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.startTime} - ${record.endTime}</td>
                    <td>${record.restTime} / <span class="overtime-td">${record.overtimeTime}</span></td>
                    <td>${record.actualWorkHours}</td>
                    <td>${record.workType}</td>
                    <td><button class="delete-btn" onclick="deleteRecord('${record.id}')">åˆ é™¤</button></td>
                `;
                historyBodyEl.appendChild(row);
            });
        }
    </script>
    
    </body>
</html>